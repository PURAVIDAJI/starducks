<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>

  <link rel="stylesheet" th:href="@{/css/header/style.css}" type="text/css"/>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stomp-websocket/lib/stomp.min.js"></script>


  <!--  웹소켓 연결할 때는 토큰 필요 -->
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
</head>
<body>
<div id="chat-room">
  <div th:each="message : ${messages}">
    <div th:class="${message.sender == #authentication.name} ? 'chat-message current-user' : 'chat-message other-user'">
      <div class="message-content" th:text="${message.message}">메시지 내용</div>
    </div>
  </div>
</div>

<footer>
  <form id="messageForm">
    <input type="text" id="message" placeholder="메시지 입력"/>
    <button type="button" onclick="sendMessage()">전송</button>
  </form>
</footer>

<script th:inline="javascript">
  /*<![CDATA[*/
  const roomId = [[${roomId}]]; // 채팅방 ID
  const currentUser = [[${currentUserId}]]; // 현재 로그인한 사용자의 ID
  /*]]>*/
</script>
<script>
  window.onload = function() {
    // 페이지가 로드되면 스크롤을 가장 아래로 이동
    window.scrollTo(0, document.body.scrollHeight);
  };

  let stompClient = null;

  function connect() {
    // CSRF 토큰과 헤더 이름 읽기
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const socket = new SockJS('/chat-websocket', null, {
      headers: { [csrfHeader]: csrfToken }
    });

    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/topic/chatroom/' + roomId, function(messageOutput) {
        showMessage(JSON.parse(messageOutput.body));
      });
    });
  }

  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    console.log("Disconnected");
  }

  function sendMessage() {
    const messageContent = document.getElementById('message').value.trim();
    if(messageContent && stompClient) {
      const chatMessage = {
        sender: [[${#authentication.name}]], // 현재 로그인한 사용자의 이름
        content: messageContent,
        type: 'CHAT'
      };
      stompClient.send("/app/chat.send/" + roomId, {}, JSON.stringify(chatMessage));
      document.getElementById('message').value = '';
    }
  }

  function showMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message');

    // 현재 사용자와 메시지 발신자가 같으면 오른쪽에 표시
    if (message.sender === currentUser) {
      messageElement.classList.add('current-user');
    } else {
      messageElement.classList.add('other-user');
    }

    const textElement = document.createElement('div');
    textElement.classList.add('message-content');
    textElement.innerHTML = message.sender + ': ' + message.content;

    messageElement.appendChild(textElement);
    document.getElementById('chat-room').appendChild(messageElement);

    // 스크롤을 최신 메시지 위치로 이동
    window.scrollTo(0, document.body.scrollHeight);
  }

  // 채팅방 페이지가 로드될 때 WebSocket 연결을 시작
  connect();

  // 채팅방 페이지를 벗어날 때 WebSocket 연결 해제
  window.onbeforeunload = function(e) {
    disconnect();
  };
</script>
</body>
</html>