<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>

  <link rel="stylesheet" th:href="@{/css/header/style.css}" type="text/css"/>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stomp-websocket/lib/stomp.min.js"></script>


  <!--  웹소켓 연결할 때는 토큰 필요 -->
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
</head>
<body>
<div id="chat-room">
  <div th:each="message : ${messages}" th:class="${message.senderId == currentUserId} ? 'chat-window-message current-user' : 'chat-window-message other-user'">
    <div class="chat-window-message-content" th:text="${message.senderName + ': ' + message.message}"></div>
  </div>
</div>

<footer>
  <form id="messageForm">
    <input type="text" id="message" placeholder="메시지 입력"/>
    <button type="button" onclick="sendMessage()">전송</button>
  </form>
</footer>

<script th:inline="javascript">
  /*<![CDATA[*/
  const roomId = [[${roomId}]]; // 채팅방 ID
  const currentUser = [[${currentUserId}]]; // 현재 로그인한 사용자의 ID
  /*]]>*/
</script>
<script>
  window.onload = function() {
    // 페이지가 로드되면 스크롤을 가장 아래로 이동
    window.scrollTo(0, document.body.scrollHeight);

  };
  let stompClient = null;

  function connect() {
    // CSRF 토큰과 헤더 이름 읽기
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const socket = new SockJS('/chat', null, {
      headers: { [csrfHeader]: csrfToken }
    });

    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/topic/chatroom/' + roomId, function(messageOutput) {
        showMessage(JSON.parse(messageOutput.body));
      });
    });
  }

  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    console.log("Disconnected");
  }

  function sendMessage() {
    const messageContent = document.getElementById('message').value.trim();
    if (messageContent && stompClient) {
      const chatMessage = {
        sender: currentUser, // 현재 로그인한 사용자의 ID
        message: messageContent,
        type: 'CHAT'
      };
      stompClient.send("/app/chat/" + roomId + "/send", {}, JSON.stringify(chatMessage));
      document.getElementById('message').value = '';
    }
  }

  function showMessage(message) {
    // 메시지 ID를 기반으로 중복 렌더링 방지
    if (document.getElementById(`message-${message.id}`)) {
      return; // 이미 렌더링된 메시지는 추가하지 않음
    }

    const messageElement = document.createElement('div');
    messageElement.id = `message-${message.id}`; // 메시지 요소에 고유 ID 할당
    messageElement.classList.add('chat-window-message');

    // 현재 사용자와 메시지 발신자가 같으면 오른쪽에 표시
    if (message.senderId === currentUser) {
      messageElement.classList.add('current-user');
    } else {
      messageElement.classList.add('other-user');
    }

    const textElement = document.createElement('div');
    textElement.classList.add('chat-window-message-content');
    textElement.innerHTML = message.senderName + ': ' + message.message;

    messageElement.appendChild(textElement);

    // 메시지를 채팅방의 끝에 추가하여 최신 메시지가 하단에 위치하도록 함
    const chatRoomElement = document.getElementById('chat-room');
    chatRoomElement.appendChild(messageElement); // 변경된 부분

    // 스크롤을 최신 메시지 위치로 이동
    window.scrollTo(0, document.body.scrollHeight);
  }

  // 채팅방 페이지가 로드될 때 WebSocket 연결을 시작
  connect();

  // 채팅방 페이지를 벗어날 때 WebSocket 연결 해제
  window.onbeforeunload = function() {
    disconnect();
  };
</script>
</body>
</html>