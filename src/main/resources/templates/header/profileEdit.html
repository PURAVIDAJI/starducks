<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <title>개인 정보 수정</title>

  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>

</head>
<body>
<h1 class="p-custom">개인 정보 수정</h1>
<form id="form" class="form-custom" th:action="@{/profileEdit/update}" method="post" th:object="${employee}" autocomplete="off">
  <!--  토큰 추가 -->
  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
  <div id="formSection" class="formSection-custom">
    <section>
      <!-- 사원번호 -->
      <dl class="dl-custom">
        <dt class="dt-custom">사원 번호</dt>
        <dd class="dd-custom"><input type="text" th:value="*{empId}" disabled></dd>
        <input type="hidden" th:field="*{empId}" />
      </dl>
      <!-- 사원 이름 -->
      <dl class="dl-custom">
        <dt class="dt-custom">사원 이름</dt>
        <dd class="dd-custom"><input type="text" th:value="*{empName}" disabled></dd>
      </dl>
      <!-- 연락처 -->
      <dl class="dl-custom">
        <dt class="dt-custom">연락처</dt>
        <dd class="dd-custom"><input type="text" th:field="*{empTel}"></dd>
      </dl>
      <!-- 이메일 -->
      <dl class="dl-custom">
        <dt class="dt-custom">이메일</dt>
        <dd class="dd-custom"><input type="email" th:field="*{email}"></dd>
      </dl>
      <!-- 성별 -->
      <dl class="dl-custom">
        <dt class="dt-custom">성별</dt>
        <dd class="dd-custom"><input type="text" th:value="*{gender}" disabled></dd>
      </dl>
      <!-- 생년월일 -->
      <dl class="dl-custom">
        <dt class="dt-custom">생년월일</dt>
        <dd class="dd-custom"><input type="date" th:value="*{birth}" disabled></dd>
      </dl>
    </section>
    <section>
      <!-- 부서 -->
      <dl class="dl-custom">
        <dt class="dt-custom">부서</dt>
        <dd class="dd-custom"><input type="text" th:value="*{dept.deptName}" disabled></dd>
      </dl>
      <!-- 직급 -->
      <dl class="dl-custom">
        <dt class="dt-custom">직급</dt>
        <dd class="dd-custom"><input type="text" th:value="*{position}" disabled></dd>
      </dl>
      <!-- 입사 일자 -->
      <dl class="dl-custom">
        <dt class="dt-custom">입사 일자</dt>
        <dd class="dd-custom"><input type="date" th:value="*{joinDate}" disabled></dd>
      </dl>
      <!-- 퇴사 여부 -->
      <dl class="dl-custom">
        <dt class="dt-custom">퇴사 여부</dt>
        <dd class="dd-custom"><input type="text" th:value="*{status ? '퇴사' : '재직'}" disabled></dd>
      </dl>
      <!-- 우편번호 -->
      <dl class="dl-custom">
        <dt class="dt-custom">우편번호</dt>
        <dd class="dd-custom">
          <input type="text" class="postNo-custom" th:field="*{postNo}">
          <button type="button" class="button-custom" onclick="findPostalCode()">우편번호 찾기</button>
        </dd>
      </dl>
      <!-- 주소 -->
      <dl class="dl-custom">
        <dt class="dt-custom">주소</dt>
        <dd class="dd-custom"><input type="text" th:field="*{addr}"></dd>
      </dl>
      <!-- 상세주소 -->
      <dl class="dl-custom">
        <dt class="dt-custom">상세주소</dt>
        <dd class="dd-custom"><input type="text" th:field="*{dAddr}"></dd>
      </dl>
    </section>
  </div>
  <!-- 비밀번호 변경 -->
  <dl class="dl-custom">
    <dt class="dt-custom">기존 비밀번호</dt>
    <dd class="dd-custom">
      <input type="password" id="currentPassword" placeholder="현재 비밀번호 입력">
      <button type="button" onclick="checkCurrentPassword()">확인</button>
    </dd>
  </dl>

  <!-- 새 비밀번호 -->
  <dl class="dl-custom">
    <dt class="dt-custom">새 비밀번호</dt>
    <dd class="dd-custom">
      <input type="password" id="newPassword" placeholder="새 비밀번호 입력" disabled>
    </dd>
  </dl>

  <!-- 새 비밀번호 확인 -->
  <dl class="dl-custom">
    <dt class="dt-custom">새 비밀번호 확인</dt>
    <dd class="dd-custom">
      <input type="password" id="newPasswordConfirm" placeholder="새 비밀번호 확인" disabled>
    </dd>
  </dl>
  <div class="btns-custom">
    <button type="submit" class="commonBtn-custom register-button">저장</button>
    <a th:href="@{/profileEdit}"><p class="commonBtn-custom cancel-button">취소</p></a>
  </div>
</form>
<script>
  function checkCurrentPassword() {
    const currentPassword = document.getElementById("currentPassword").value;
    const empId = document.getElementById('empId').value;
    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    $.ajax({
      url: "/profileEdit/checkPassword",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({ empId: empId, currentPassword: currentPassword }),
      beforeSend: function(xhr) {
        xhr.setRequestHeader(header, token); // CSRF 토큰을 헤더에 추가
      },
      success: function(isMatch) {
        if (isMatch) {
          document.getElementById("newPassword").disabled = false;
          document.getElementById("newPasswordConfirm").disabled = false;
        } else {
          alert("현재 비밀번호가 일치하지 않습니다.");
        }
      }
    });
  }

  function validatePassword() {
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("newPasswordConfirm").value;
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;

    if (!newPassword.match(passwordRegex)) {
      alert("비밀번호는 영문, 숫자 조합으로 8자리 이상이어야 합니다.");
      return false;
    }

    if (newPassword !== confirmPassword) {
      alert("새 비밀번호가 일치하지 않습니다.");
      return false;
    }

    return true;
  }

  document.getElementById("passwordForm").onsubmit = function () {
    return validatePassword();
  };
</script>
</body>
</html>
